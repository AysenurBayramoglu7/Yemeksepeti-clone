@model IEnumerable<YemekSepeti.Entities.Dtos.SiparisGecmisiDto> //SP ile gelen sipariş geçmişi verileri
@using YemekSepeti.Entities

@{
    ViewData["Title"] = "Siparişlerim";
    Layout = "_Layout";
}

<div class="container mt-5">
    <h2 class="mb-4">Siparişlerim</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            Henüz hiç siparişiniz yok. <a asp-controller="Home" asp-action="Index">Alışverişe Başla</a>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Sipariş No</th>
                        <th>Tarih</th>
                        <th>Durum</th>
                        <th>Tutar</th>
                        <th>Takip Kodu</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>#@item.SiparisID</td>
                            <td>@item.Tarih.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>
                                <span class="badge bg-secondary">@((SiparisDurumu)item.Durum)</span>
                            </td>
                            <td>@item.ToplamTutar.ToString("C2")</td>
                            <td>@item.TakipKodu</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white" onclick="toggleDetay('@item.SiparisID')">
                                    Detaylar <i class="bi bi-chevron-down"></i>
                                </button>
                            </td>
                        </tr>
                        <tr id="detay-row-@item.SiparisID" style="display:none;">
                            <td colspan="6">
                                <div class="p-3 bg-light border rounded">
                                    <h5>Sipariş İçeriği</h5>
                                    <div id="loading-@item.SiparisID" class="text-center text-muted">
                                        <div class="spinner-border spinner-border-sm" role="status"></div> Yükleniyor...
                                    </div>
                                    <table class="table table-sm mb-0 bg-white" id="table-@item.SiparisID" style="display:none;">
                                        <thead>
                                            <tr>
                                                <th>Ürün</th>
                                                <th>Adet</th>
                                                <th>Birim Fiyat</th>
                                                <th>Toplam</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- JS ile burası dolacak -->
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@section Scripts {
    <script>
        console.log("Siparis/Index Scripts Loaded");

        function toggleDetay(id) {
            console.log("toggleDetay called for ID:", id);
            var row = document.getElementById('detay-row-' + id);

            if (!row) {
                console.error("Row Element Not Found! ID: detal-row-" + id);
                return;
            }

            if (row.style.display !== 'none') {
                row.style.display = 'none';
                return;
            }

            row.style.display = 'table-row';

            var table = document.getElementById('table-' + id);
            var loading = document.getElementById('loading-' + id);
            var tbody = table.getElementsByTagName('tbody')[0];

            if (tbody.innerHTML.trim() !== "") {
                loading.style.display = 'none';
                table.style.display = 'table';
                return;
            }

            const url = '/Siparis/DetayGetir?siparisId=' + id;
            console.log("FETCH URL:", url);

            fetch(url, { method: 'GET' })
                .then(async (response) => {
                    const text = await response.text();
                    console.log("STATUS:", response.status);
                    
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                         console.error("JSON PARSE ERROR. Response text:", text);
                         throw new Error("JSON verisi dönmedi. Giriş sayfası dönüyor olabilir.");
                    }
                    return data;
                })
                .then(data => {
                    console.log("PARSED DATA:", data);

                    loading.style.display = 'none';
                    table.style.display = 'table';

                    if (!Array.isArray(data) || data.length === 0) {
                        tbody.innerHTML = `
                          <tr>
                            <td colspan="4" class="text-center text-muted">
                              Sipariş detayı bulunamadı.
                            </td>
                          </tr>`;
                        return;
                    }

                    var html = '';

                    data.forEach(item => {
                        // Backend DTO casing farkı ihtimaline karşı:
                        const urunAdi = item.urunAd ?? item.UrunAd ?? '-';
                        const adet = item.adet ?? item.Adet ?? 0;
                        const fiyat = item.fiyat ?? item.Fiyat ?? 0;
                        const toplam = (adet * fiyat).toFixed(2);

                        html += `
                            <tr>
                                <td>${urunAdi}</td>
                                <td>${adet}</td>
                                <td>${fiyat} ₺</td>
                                <td>${toplam} ₺</td>
                            </tr>
                        `;
                    });

                    tbody.innerHTML = html;
                })
                .catch(err => {
                    console.error("DETAY HATASI:", err);
                    loading.innerHTML = `<span class="text-danger">${err.message}</span>`;
                });
        }
    </script>
}

